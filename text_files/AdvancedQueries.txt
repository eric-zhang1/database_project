/*This query returns a list of member names, along with the total combined amount of all items they have rented out*/

SELECT Customer.Fname, Customer.Lname, COUNT(Rental.Rental_ID) AS Num_Items
FROM Customer JOIN Rental ON User_ID = Customer_ID
GROUP BY Customer.User_ID, Customer.Fname, Customer.Lname;

/* Provide a list of member names and email addresses for members who have rented more equipment than the average member. */

SELECT FName, LName, Email  
FROM Customer  
WHERE User_ID IN ( 
    SELECT Customer_ID 
    FROM RENTAL 
    GROUP BY Customer_ID 
    HAVING Count(Rental_ID) > 
        (SELECT AVG(AmtRented) 
        FROM ( SELECT Customer_ID, Count(Rental_ID) AS AmtRented 
                FROM Rental 
                GROUP by Customer_ID) 
            ) 
);

/* Provide a list of the equipment in the database and associated total copies rented to members, 
    sorted from the equipment that has been rented the most to the equipment that has been rented the least. */

SELECT Model, COUNT(RENTAL.Equipment_ID) AS Total_Copies_Rented 
FROM EQUIPMENT_MAIN 
JOIN RENTAL ON EQUIPMENT_MAIN.Serial_Number = RENTAL.Equipment_ID 
GROUP BY EQUIPMENT_MAIN.Model 
ORDER BY Total_Copies_Rented DESC; 

/* Provide a list of the drones in the database and the total number of miles flown, 
    sorted from the ones that have been delivered the highest number of items to the ones delivered the lowest.*/

SELECT Serial_Number, Model, SUM(DRONE_TYPE.Distance_Autonomy) AS Total_Miles_Flown 
FROM DRONE_MAIN 
JOIN RENTAL ON DRONE_MAIN.Serial_Number = RENTAL.Delivery_Drone_ID 
JOIN DRONE_TYPE ON DRONE_MAIN.Model = DRONE_TYPE.Model 
GROUP BY DRONE_MAIN.Serial_Number, DRONE_MAIN.Model 
ORDER BY Total_Miles_Flown DESC; 

/* Find the most popular manufacturer in the database (i.e. the one who has had the most rented items) */

SELECT Manufacturer, COUNT(RENTAL.Equipment_ID) AS Total_Rentals 
FROM EQUIPMENT_MAIN 
JOIN RENTAL ON EQUIPMENT_MAIN.Serial_Number = RENTAL.Equipment_ID 
JOIN EQUIPMENT_TYPE ON EQUIPMENT_MAIN.Model = EQUIPMENT_TYPE.Model  
GROUP BY EQUIPMENT_TYPE.Manufacturer 
ORDER BY Total_Rentals DESC 
LIMIT 1; 

/* Find the most used items in the database, use the running rented time of the item to calculate and provide also the number of times the item has been rented out. 
    The output should be ordered from the highest running rented time to the lowest. */

SELECT EM.Model, EM.Manufacturer, COUNT(R.Rental_ID) AS TimesRented, SUM (R.Due_Date AND R.Checkout_Date) AS TotalTime 
FROM Equipment_Main as EM, Rental as R
JOIN Rental ON EM.Serial_Number = R.Equipment_ID 
GROUP BY R.Equipment_ID 
ORDER BY TotalTime DESC;

/* Provide the names and phones of members who have rented out anything by the most demanded equipment in the database. */

SELECT Fname, Lname, Phone 
FROM CUSTOMER 
JOIN RENTAL ON CUSTOMER.User_ID = RENTAL.Customer_ID 
WHERE RENTAL.Equipment_ID IN ( 
    SELECT Equipment_ID 
    FROM RENTAL 
    GROUP BY Equipment_ID 
    ORDER BY COUNT(*) DESC 
    LIMIT 1 
); 

/* Provide a list of manufacturers who provided the items rented out by members who have rented more items than the average customer. */

SELECT DISTINCT EM.Manufacturer 
FROM Equipment_MAIN AS EM 
JOIN RENTAL AS R ON EM.Serial_Number = R.Equipment_ID 
WHERE R.Customer_ID IN ( 
    SELECT Customer_ID  
    FROM Rental  
    GROUP BY Customer_ID  
    HAVING COUNT(Rental_ID) >  
        ( SELECT AVG(AmtRented)  
        FROM ( SELECT Customer_ID, COUNT(Rental_ID) AS AmtRented  
        FROM Rental  
        GROUP BY Customer_ID ) 
        ) 
); 
